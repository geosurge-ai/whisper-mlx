#!/usr/bin/env bash
# Install Qwen Daemon as a macOS LaunchAgent service
# Usage: ./install-service [install|uninstall|status|logs]

set -euo pipefail

SERVICE_DAEMON="com.qwen.daemon"
SERVICE_FRONTEND="com.qwen.frontend"
PLIST_DAEMON="$HOME/Library/LaunchAgents/${SERVICE_DAEMON}.plist"
PLIST_FRONTEND="$HOME/Library/LaunchAgents/${SERVICE_FRONTEND}.plist"
PROJECT_DIR="$(cd "$(dirname "$0")" && pwd)"
LOG_DIR="$HOME/.qwen/logs"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

info() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }

check_prerequisites() {
    # Check nix is available
    if ! command -v nix &>/dev/null; then
        error "nix not found. Please install Nix first."
        exit 1
    fi

    # Check .venv exists
    if [[ ! -d "$PROJECT_DIR/.venv" ]]; then
        error ".venv not found. Please run: nix develop --command python -m venv .venv && source .venv/bin/activate && pip install -r requirements.txt"
        exit 1
    fi

    # Check if nix flake is valid
    if [[ ! -f "$PROJECT_DIR/flake.nix" ]]; then
        error "flake.nix not found in $PROJECT_DIR"
        exit 1
    fi
}

generate_daemon_plist() {
    mkdir -p "$LOG_DIR"
    mkdir -p "$(dirname "$PLIST_DAEMON")"

    cat > "$PLIST_DAEMON" << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>${SERVICE_DAEMON}</string>

    <key>ProgramArguments</key>
    <array>
        <string>/nix/var/nix/profiles/default/bin/nix</string>
        <string>develop</string>
        <string>${PROJECT_DIR}</string>
        <string>--command</string>
        <string>bash</string>
        <string>-c</string>
        <string>source .venv/bin/activate &amp;&amp; exec python -m daemon.server</string>
    </array>

    <key>WorkingDirectory</key>
    <string>${PROJECT_DIR}</string>

    <key>EnvironmentVariables</key>
    <dict>
        <key>HOME</key>
        <string>${HOME}</string>
        <key>PATH</key>
        <string>/nix/var/nix/profiles/default/bin:/usr/bin:/bin:/usr/sbin:/sbin</string>
        <key>PYTHONPATH</key>
        <string>${PROJECT_DIR}</string>
        <key>TOKENIZERS_PARALLELISM</key>
        <string>false</string>
    </dict>

    <key>RunAtLoad</key>
    <true/>

    <key>KeepAlive</key>
    <dict>
        <key>SuccessfulExit</key>
        <false/>
        <key>Crashed</key>
        <true/>
    </dict>

    <key>ThrottleInterval</key>
    <integer>10</integer>

    <key>StandardOutPath</key>
    <string>${LOG_DIR}/daemon.stdout.log</string>

    <key>StandardErrorPath</key>
    <string>${LOG_DIR}/daemon.stderr.log</string>

    <key>ProcessType</key>
    <string>Background</string>
</dict>
</plist>
EOF
    info "Generated daemon plist at $PLIST_DAEMON"
}

generate_frontend_plist() {
    mkdir -p "$LOG_DIR"
    mkdir -p "$(dirname "$PLIST_FRONTEND")"

    cat > "$PLIST_FRONTEND" << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>${SERVICE_FRONTEND}</string>

    <key>ProgramArguments</key>
    <array>
        <string>/nix/var/nix/profiles/default/bin/nix</string>
        <string>develop</string>
        <string>${PROJECT_DIR}</string>
        <string>--command</string>
        <string>bash</string>
        <string>-c</string>
        <string>cd frontend &amp;&amp; pnpm dev</string>
    </array>

    <key>WorkingDirectory</key>
    <string>${PROJECT_DIR}</string>

    <key>EnvironmentVariables</key>
    <dict>
        <key>HOME</key>
        <string>${HOME}</string>
        <key>PATH</key>
        <string>/nix/var/nix/profiles/default/bin:/usr/bin:/bin:/usr/sbin:/sbin</string>
    </dict>

    <key>RunAtLoad</key>
    <true/>

    <key>KeepAlive</key>
    <dict>
        <key>SuccessfulExit</key>
        <false/>
        <key>Crashed</key>
        <true/>
    </dict>

    <key>ThrottleInterval</key>
    <integer>10</integer>

    <key>StandardOutPath</key>
    <string>${LOG_DIR}/frontend.stdout.log</string>

    <key>StandardErrorPath</key>
    <string>${LOG_DIR}/frontend.stderr.log</string>

    <key>ProcessType</key>
    <string>Background</string>
</dict>
</plist>
EOF
    info "Generated frontend plist at $PLIST_FRONTEND"
}

do_install() {
    info "Installing Qwen services..."
    check_prerequisites

    # Unload if already loaded
    if launchctl list 2>/dev/null | grep -q "$SERVICE_DAEMON"; then
        warn "Daemon service already loaded. Unloading first..."
        launchctl unload "$PLIST_DAEMON" 2>/dev/null || true
    fi
    if launchctl list 2>/dev/null | grep -q "$SERVICE_FRONTEND"; then
        warn "Frontend service already loaded. Unloading first..."
        launchctl unload "$PLIST_FRONTEND" 2>/dev/null || true
    fi

    generate_daemon_plist
    generate_frontend_plist

    info "Loading daemon service..."
    launchctl load "$PLIST_DAEMON"

    info "Loading frontend service..."
    launchctl load "$PLIST_FRONTEND"

    # Verify they're running
    sleep 3
    echo ""
    do_status
}

do_uninstall() {
    info "Uninstalling Qwen services..."

    if [[ -f "$PLIST_DAEMON" ]]; then
        launchctl unload "$PLIST_DAEMON" 2>/dev/null || true
        rm -f "$PLIST_DAEMON"
        info "Daemon service uninstalled."
    else
        warn "Daemon plist not found at $PLIST_DAEMON"
    fi

    if [[ -f "$PLIST_FRONTEND" ]]; then
        launchctl unload "$PLIST_FRONTEND" 2>/dev/null || true
        rm -f "$PLIST_FRONTEND"
        info "Frontend service uninstalled."
    else
        warn "Frontend plist not found at $PLIST_FRONTEND"
    fi
}

show_service_status() {
    local name="$1"
    local service_id="$2"
    local svc_info
    svc_info=$(launchctl list 2>/dev/null | grep "$service_id" || true)
    if [[ -n "$svc_info" ]]; then
        local pid=$(echo "$svc_info" | awk '{print $1}')
        if [[ "$pid" != "-" && "$pid" =~ ^[0-9]+$ ]]; then
            echo -e "  $name: ${GREEN}Running${NC} (PID: $pid)"
        else
            echo -e "  $name: ${YELLOW}Loaded but not running${NC}"
        fi
    else
        echo -e "  $name: ${RED}Not installed${NC}"
    fi
}

do_status() {
    echo "=== Service Status ==="
    show_service_status "Daemon" "$SERVICE_DAEMON"
    show_service_status "Frontend" "$SERVICE_FRONTEND"

    echo ""
    echo "=== Health Check ==="
    if curl -s http://127.0.0.1:5997/health 2>/dev/null | grep -q "healthy"; then
        echo -e "  Backend API (5997): ${GREEN}Healthy${NC}"
    else
        echo -e "  Backend API (5997): ${RED}Not responding${NC}"
    fi
    if curl -s http://127.0.0.1:8792/ 2>/dev/null | grep -q -E "(html|script)"; then
        echo -e "  Frontend UI (8792): ${GREEN}Running${NC}"
    else
        echo -e "  Frontend UI (8792): ${RED}Not responding${NC}"
    fi

    echo ""
    echo "=== URLs ==="
    echo "  Frontend: http://localhost:8792"
    echo "  API:      http://localhost:5997"

    echo ""
    echo "=== Log Files ==="
    echo "  Daemon:   $LOG_DIR/daemon.stderr.log"
    echo "  Frontend: $LOG_DIR/frontend.stderr.log"

    echo ""
    echo "=== Synced Data ==="
    local data_dir="$HOME/.qwen/data"
    if [[ -d "$data_dir" ]]; then
        for acc_dir in "$data_dir"/*/; do
            [[ -d "$acc_dir" ]] || continue
            local acc=$(basename "$acc_dir")
            local emails=$(find "$acc_dir/gmail/emails" -name "*.json" 2>/dev/null | wc -l | tr -d ' ')
            local attachments=$(find "$acc_dir/gmail/attachments" -type f 2>/dev/null | wc -l | tr -d ' ')
            local events=$(find "$acc_dir/calendar/events" -name "*.json" 2>/dev/null | wc -l | tr -d ' ')
            echo "  $acc: ${emails} emails, ${attachments} attachments, ${events} events"
        done
    else
        echo "  No data synced yet"
    fi
}

do_logs() {
    local service="${2:-all}"

    if [[ "$service" == "all" || "$service" == "daemon" ]]; then
        echo "=== Daemon Logs (last 30 lines) ==="
        tail -30 "$LOG_DIR/daemon.stderr.log" 2>/dev/null || echo "  (no logs yet)"
        echo ""
    fi

    if [[ "$service" == "all" || "$service" == "frontend" ]]; then
        echo "=== Frontend Logs (last 20 lines) ==="
        tail -20 "$LOG_DIR/frontend.stderr.log" 2>/dev/null || echo "  (no logs yet)"
    fi
}

do_restart() {
    info "Restarting Qwen services..."

    if [[ -f "$PLIST_DAEMON" ]]; then
        launchctl unload "$PLIST_DAEMON" 2>/dev/null || true
    fi
    if [[ -f "$PLIST_FRONTEND" ]]; then
        launchctl unload "$PLIST_FRONTEND" 2>/dev/null || true
    fi

    sleep 1

    if [[ -f "$PLIST_DAEMON" ]]; then
        launchctl load "$PLIST_DAEMON"
    else
        error "Daemon not installed. Run: $0 install"
        exit 1
    fi

    if [[ -f "$PLIST_FRONTEND" ]]; then
        launchctl load "$PLIST_FRONTEND"
    fi

    sleep 3
    do_status
}

# Main
case "${1:-help}" in
    install)
        do_install
        ;;
    uninstall|remove)
        do_uninstall
        ;;
    status)
        do_status
        ;;
    logs)
        do_logs
        ;;
    restart)
        do_restart
        ;;
    *)
        echo "Qwen Service Manager"
        echo ""
        echo "Usage: $0 <command>"
        echo ""
        echo "Commands:"
        echo "  install    Install and start daemon + frontend as LaunchAgents"
        echo "  uninstall  Stop and remove both LaunchAgents"
        echo "  status     Show service status and health check"
        echo "  restart    Restart both services"
        echo "  logs       Show recent log output"
        echo ""
        echo "The services will:"
        echo "  - Start automatically on login"
        echo "  - Restart if they crash"
        echo "  - Sync Gmail/Calendar in the background"
        echo ""
        echo "URLs:"
        echo "  Frontend: http://localhost:8792"
        echo "  API:      http://localhost:5997"
        echo ""
        echo "Log files: $LOG_DIR/"
        ;;
esac
