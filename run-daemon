#!/usr/bin/env bash
# Run the Qwen daemon server
# Usage: ./run-daemon [--host HOST] [--port PORT]

set -euo pipefail

cd "$(dirname "$0")"

# Ensure we're in nix shell with dependencies
if [[ -z "${IN_NIX_SHELL:-}" ]]; then
    exec nix develop --command "$0" "$@"
fi

# Activate venv if it exists (contains pip-installed packages)
if [[ -d ".venv" ]]; then
    source .venv/bin/activate
fi

export PYTHONPATH="${PYTHONPATH:-}:$(pwd)"

echo "Starting Qwen Daemon..."
echo "  Host: ${1:-127.0.0.1}"
echo "  Port: ${2:-5997}"
echo ""
echo "Endpoints:"
echo "  GET  /health        - Health check"
echo "  POST /v1/chat       - Chat completion"
echo "  POST /v1/invoke-tool - Direct tool invocation"
echo "  GET  /v1/profiles   - List profiles"
echo "  GET  /v1/tools      - List tools"
echo ""

# Check Google sync setup
OAUTH_SOURCE=""
if passveil show google/qwen-sync-oauth &>/dev/null; then
    OAUTH_SOURCE="passveil"
elif [[ -f "$HOME/.qwen/client_secrets.json" ]]; then
    OAUTH_SOURCE="file"
fi

if [[ -n "$OAUTH_SOURCE" ]]; then
    ACCOUNTS=$(python -c "from daemon.sync.auth import list_accounts; print(', '.join(list_accounts()) or 'none')" 2>/dev/null || echo "error")
    echo "Google Sync:"
    echo "  OAuth configured: ✓ (from $OAUTH_SOURCE)"
    echo "  Accounts: $ACCOUNTS"
    if [[ "$ACCOUNTS" == "none" ]]; then
        echo "  ⚠️  No accounts authenticated. Run: python -m daemon.sync.auth --account NAME"
    fi
else
    echo "Google Sync:"
    echo "  OAuth configured: ✗"
    echo "  ⚠️  To enable Gmail/Calendar sync, see docs/AUTH.md"
fi
echo ""

python -m daemon.server "$@"
